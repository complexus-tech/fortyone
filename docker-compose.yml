services:
  web:
    image: fortyoneapp/web:latest
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:8000}
      INTERNAL_API_URL: ${INTERNAL_API_URL:-http://server:8000}
      NEXT_PUBLIC_DOMAIN: ${NEXT_PUBLIC_DOMAIN:-localhost}
      AUTH_SECRET: ${AUTH_SECRET:-changeme}
    ports:
      - "${WEB_PORT:-3000}:3000"
    depends_on:
      - server

  server:
    image: fortyoneapp/server:latest
    environment:
      APP_DB_HOST: ${APP_DB_HOST:-postgres}
      APP_DB_PORT: ${APP_DB_PORT:-5432}
      APP_DB_USER: ${APP_DB_USER:-postgres}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD:-postgres}
      APP_DB_NAME: ${APP_DB_NAME:-fortyone}
      APP_DB_DISABLE_TLS: ${APP_DB_DISABLE_TLS:-true}
      APP_REDIS_HOST: ${APP_REDIS_HOST:-redis}
      APP_REDIS_PORT: ${APP_REDIS_PORT:-6379}
      APP_REDIS_PASSWORD: ${APP_REDIS_PASSWORD:-}
      APP_REDIS_DISABLE_TLS: ${APP_REDIS_DISABLE_TLS:-true}
      APP_API_HOST: ${APP_API_HOST:-0.0.0.0:8000}
      APP_WEBSITE_URL: ${APP_WEBSITE_URL:-http://localhost:3000}
      APP_TRACING_HOST: ${APP_TRACING_HOST:-jaeger:4318}
      APP_EMAIL_HOST: ${APP_EMAIL_HOST:-mailpit}
      APP_EMAIL_PORT: ${APP_EMAIL_PORT:-1025}
      APP_EMAIL_FROM_ADDRESS: ${APP_EMAIL_FROM_ADDRESS:-notifications@fortyone.local}
      APP_EMAIL_FROM_NAME: ${APP_EMAIL_FROM_NAME:-FortyOne}
      APP_EMAIL_ENVIRONMENT: ${APP_EMAIL_ENVIRONMENT:-development}
      APP_STORAGE_PROVIDER: ${APP_STORAGE_PROVIDER:-aws}
      APP_AWS_ACCESS_KEY_ID: ${APP_AWS_ACCESS_KEY_ID:-minioadmin}
      APP_AWS_SECRET_ACCESS_KEY: ${APP_AWS_SECRET_ACCESS_KEY:-minioadmin}
      APP_AWS_REGION: ${APP_AWS_REGION:-us-east-1}
      APP_AWS_ENDPOINT: ${APP_AWS_ENDPOINT:-http://minio:9000}
      APP_AWS_PUBLIC_URL: ${APP_AWS_PUBLIC_URL:-http://localhost:9000}
      APP_AWS_FORCE_PATH_STYLE: ${APP_AWS_FORCE_PATH_STYLE:-true}
      APP_AZURE_STORAGE_ACCOUNT_KEY: ${APP_AZURE_STORAGE_ACCOUNT_KEY:-}
      APP_AZURE_STORAGE_CONNECTION_STRING: ${APP_AZURE_STORAGE_CONNECTION_STRING:-}
      APP_AZURE_STORAGE_ACCOUNT_NAME: ${APP_AZURE_STORAGE_ACCOUNT_NAME:-}
    ports:
      - "${SERVER_PORT:-8000}:8000"

  worker:
    image: fortyoneapp/worker:latest
    environment:
      APP_DB_HOST: ${APP_DB_HOST:-postgres}
      APP_DB_PORT: ${APP_DB_PORT:-5432}
      APP_DB_USER: ${APP_DB_USER:-postgres}
      APP_DB_PASSWORD: ${APP_DB_PASSWORD:-postgres}
      APP_DB_NAME: ${APP_DB_NAME:-fortyone}
      APP_DB_DISABLE_TLS: ${APP_DB_DISABLE_TLS:-true}
      APP_REDIS_HOST: ${APP_REDIS_HOST:-redis}
      APP_REDIS_PORT: ${APP_REDIS_PORT:-6379}
      APP_REDIS_PASSWORD: ${APP_REDIS_PASSWORD:-}
      APP_REDIS_DISABLE_TLS: ${APP_REDIS_DISABLE_TLS:-true}
      APP_WEBSITE_URL: ${APP_WEBSITE_URL:-http://localhost:3000}
      APP_TRACING_HOST: ${APP_TRACING_HOST:-jaeger:4318}
      APP_EMAIL_HOST: ${APP_EMAIL_HOST:-mailpit}
      APP_EMAIL_PORT: ${APP_EMAIL_PORT:-1025}
      APP_EMAIL_FROM_ADDRESS: ${APP_EMAIL_FROM_ADDRESS:-notifications@fortyone.local}
      APP_EMAIL_FROM_NAME: ${APP_EMAIL_FROM_NAME:-FortyOne}
      APP_EMAIL_ENVIRONMENT: ${APP_EMAIL_ENVIRONMENT:-development}
      APP_STORAGE_PROVIDER: ${APP_STORAGE_PROVIDER:-aws}
      APP_AWS_ACCESS_KEY_ID: ${APP_AWS_ACCESS_KEY_ID:-minioadmin}
      APP_AWS_SECRET_ACCESS_KEY: ${APP_AWS_SECRET_ACCESS_KEY:-minioadmin}
      APP_AWS_REGION: ${APP_AWS_REGION:-us-east-1}
      APP_AWS_ENDPOINT: ${APP_AWS_ENDPOINT:-http://minio:9000}
      APP_AWS_PUBLIC_URL: ${APP_AWS_PUBLIC_URL:-http://localhost:9000}
      APP_AWS_FORCE_PATH_STYLE: ${APP_AWS_FORCE_PATH_STYLE:-true}
      APP_AZURE_STORAGE_ACCOUNT_KEY: ${APP_AZURE_STORAGE_ACCOUNT_KEY:-}
      APP_AZURE_STORAGE_CONNECTION_STRING: ${APP_AZURE_STORAGE_CONNECTION_STRING:-}
      APP_AZURE_STORAGE_ACCOUNT_NAME: ${APP_AZURE_STORAGE_ACCOUNT_NAME:-}
    ports:
      - "${WORKER_PORT:-8080}:8080"

  postgres:
    image: postgres:16-alpine
    profiles:
      - postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-fortyone}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_HOST_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-fortyone}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    profiles:
      - redis
    ports:
      - "${REDIS_HOST_PORT:-6380}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  jaeger:
    image: jaegertracing/all-in-one:1.56
    profiles:
      - jaeger
    ports:
      - "${JAEGER_UI_PORT:-16686}:16686"
      - "${JAEGER_GRPC_PORT:-4317}:4317"
      - "${JAEGER_HTTP_PORT:-4318}:4318"

  mailpit:
    image: axllent/mailpit:latest
    profiles:
      - mailpit
    ports:
      - "${MAILPIT_WEB_PORT:-8025}:8025"
      - "${MAILPIT_SMTP_PORT:-1025}:1025"

  minio:
    image: minio/minio:latest
    command: ["server", "/data", "--console-address", ":9001"]
    profiles:
      - minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio-data:/data

  minio-init:
    image: minio/mc:latest
    profiles:
      - minio
    environment:
      MINIO_ENDPOINT: ${MINIO_ENDPOINT:-http://minio:9000}
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      STORAGE_PROFILE_IMAGES_NAME: ${STORAGE_PROFILE_IMAGES_NAME:-profile-images}
      STORAGE_WORKSPACE_LOGOS_NAME: ${STORAGE_WORKSPACE_LOGOS_NAME:-workspace-logos}
      STORAGE_ATTACHMENTS_NAME: ${STORAGE_ATTACHMENTS_NAME:-attachments}
    depends_on:
      - minio
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        mc alias set local "$MINIO_ENDPOINT" "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"
        mc mb --ignore-existing "local/$STORAGE_PROFILE_IMAGES_NAME"
        mc mb --ignore-existing "local/$STORAGE_WORKSPACE_LOGOS_NAME"
        mc mb --ignore-existing "local/$STORAGE_ATTACHMENTS_NAME"

volumes:
  postgres-data:
  redis-data:
  minio-data:
